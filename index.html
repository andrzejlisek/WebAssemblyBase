<!doctype html> 
<html>
   <head> 
      <meta charset="utf-8">
      <title>WebAssembly test</title>
      <style>
         div { border-style:solid; } 
      </style>
   </head>
   <body>
      <a href="hello.cpp">C++ file</a><br>
      <a href="hello.wasm">WASM file</a><br>
      <pre>emcc hello.cpp -Os -s WASM=1 -s SIDE_MODULE=1 -o hello.wasm</pre>
      <div id="textcontent"></div>
      <input type="button" value="Test" onclick="Test()">
      <input type="button" value="Start" onclick="ThrStart()">
      <input type="button" value="Stop" onclick="ThrStop()">
      <input type="button" value="Status" onclick="ThrStatus()">
      <script> 
      
        // WebAssembly module
        let WasmModule;

        // WebAssembly instance
        let WasmInstance;

        // Write information text into bordered div element
        function Info(Msg)
        {
            document.getElementById("textcontent").innerHTML = document.getElementById("textcontent").innerHTML + Msg + "<br>";
        }
         
        // Create list of object members - https://flaviocopes.com/how-to-list-object-methods-javascript/
        function getMethods(obj)
        {
           let properties = new Set()
           let currentObj = obj
           do {
             Object.getOwnPropertyNames(currentObj).map(item => properties.add("[" + typeof obj[item] + "] " + item));
           } while ((currentObj = Object.getPrototypeOf(currentObj)));
           let ItemList = [...properties.keys()];
           return ItemList;
        }

        // Get string from pointer
        function GetString(Ptr)
        {
            const memoryArr = new Uint8Array(ImportObj.env.memory.buffer);
            let response = '';
            while(memoryArr[Ptr]){
              response = response + String.fromCharCode(memoryArr[Ptr]);
              Ptr++;
            }
            return response;
        }
        
        // Create string into pointer
        function SetString(Str)
        {
        }


        // Object passed into instance creating function
        // https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Memory
        // potrzebny w przypadku, gdy w C++ jest tworzenie tablic, obiektÃ³w.
        const ImportObj = {
              wasi_snapshot_preview1: {
                proc_exit: arg => {
                  console.log("Funkcja proc_exit");
                  console.log(arg);
                },
                clock_time_get: arg => {
                  console.log("Funkcja clock_time_get");
                  return performance.now();
                }
              },
              env: {
                memoryBase: 0,
                tableBase: 0,
                __memory_base: 0,
                __table_base: 0,
                memory: new WebAssembly.Memory({
                  initial: 256
                }),
                table: new WebAssembly.Table({
                  initial: 0,
                  element: 'anyfunc'
                }),
                callback1: () => {
                  Info("ImportObj: Callback1");
                  return 456;
                },
                callback2: (arg1, arg2) => {
                  Info("ImportObj: Callback2: " + arg1 + ", " + arg2);
                  return 456;
                },
                callback3: (arg) => {
                  Info("ImportObj: Callback3: " + GetString(arg));
                  return 456;
                },
                emscripten_run_script: arg => {
                  Info("ImportObj: emscripten_run_script: " + GetString(arg));
                  return 0;
                }
              }
            }


        // Work test by invoking some simple functions
        function Test()
        {
            Info("Integer test start");
            Info("fib(6)=" + WasmInstance.exports._Z3fibi(6));
            Info("Integer test stop");

            Info("Callback test start");
            Info("Javascript callback: " + WasmInstance.exports._Z12CallbackTesti(1));
            Info("Callback test stop");
            
            Info("Callback integer test start");
            Info("Javascript callback: " + WasmInstance.exports._Z12CallbackTesti(2));
            Info("Callback integer test stop");

            Info("Callback string test start");
            Info("Javascript callback: " + WasmInstance.exports._Z12CallbackTesti(3));
            Info("Callback string test stop");

            Info("Callback emscripten_run_script test start");
            Info("Javascript callback: " + WasmInstance.exports._Z12CallbackTesti(4));
            Info("Callback emscripten_run_script test stop");
            
            // Returning text - based on https://fsgeek.pl/post/webassembly-jak-zaczac/
            Info("String test start");
            Info("StrTest()=" + GetString(WasmInstance.exports._Z7StrTestv()));
            Info("String test stop");
        }
         
         
        function ThrStart()
        {
            Info("Thread start " + WasmInstance.exports._Z8ThrStartv());
        }
        function ThrStop()
        {
            Info("Thread stop " + WasmInstance.exports._Z7ThrStopv());
        }
        function ThrStatus()
        {
            Info("Thread status " + WasmInstance.exports._Z9ThrStatusv());
        }
         
        console.log("start");
        fetch("hello.wasm")
            .then(bytes => bytes.arrayBuffer())
            .then(mod => WebAssembly.compile(mod))
            .then(module => {
                WasmModule = module;
                console.log("Creating instance");
                let AsmModInst = new WebAssembly.Instance(module, ImportObj);
                console.log("Instance created");
                return AsmModInst;
              })
            .then(instance => {
                WasmInstance = instance;

                Info("#### WasmInstance.exports");
                Info(getMethods(WasmInstance.exports).join("<br>"));
                Info("####");
                //Info("#### ImportObj.env.memory");
                //Info(getMethods(ImportObj.env.memory).join("<br>"));
                //Info("####");
            });
      </script>
   </body>
</html>
